<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MDRO æ‚£è€…åˆ†å¸ƒåœ°å›¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.4;
    }
    
    #map { 
      height: 100vh; 
      width: 100%;
    }
    
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-width: 280px;
    }
    
    .control-panel h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
      font-weight: bold;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
      font-size: 14px;
    }
    
    .control-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .layer-toggles-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 8px;
    }
    
    .layer-toggle {
      display: flex;
      align-items: center;
      flex: 1;
      min-width: 0;
    }
    
    .layer-toggle input[type="checkbox"] {
      width: auto;
      margin-right: 6px;
    }
    
    .layer-toggle label {
      font-size: 13px;
      color: #555;
      white-space: nowrap;
    }
    
    .stats-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-width: 200px;
    }
    
    .stats-panel h3 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
      font-weight: bold;
    }
    
    .stats-item {
      margin-bottom: 8px;
      font-size: 14px;
      color: #555;
    }
    
    .stats-value {
      font-weight: bold;
      color: #e74c3c;
      font-size: 14px;
    }
    
    .legend {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-size: 14px;
      line-height: 1.4;
    }
    
    .legend h4 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 16px;
      font-weight: bold;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .legend-item span {
      font-size: 14px;
      color: #555;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid #333;
    }
    
    .colorbar-container {
      margin: 10px 0;
    }
    
    .colorbar {
      width: 100%;
      height: 20px;
      background: linear-gradient(to right, #ffffcc, #ffeda0, #fed976, #feb24c, #f03b20);
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .colorbar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #666;
      margin-top: 3px;
    }
    
    /* å‚è€ƒåŸºå­”è‚¯é›…çƒ­åœ°å›¾çš„å·¦ä¸‹è§’æ§ä»¶è®¾ç½® */
    /* è°ƒæ•´ç¼©æ”¾æ§ä»¶ä½ç½®åˆ°å·¦ä¸‹è§’æœ€åº•éƒ¨ï¼Œæ¨ªç€æ”¾ */
    .leaflet-top.leaflet-left .leaflet-control-zoom {
      position: fixed !important;
      bottom: 25px !important;
      left: 10px !important;
      top: auto !important;
      margin: 0 !important;
      border-radius: 8px !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
      border: none !important;
      /* è®©ç¼©æ”¾æŒ‰é’®æ°´å¹³æ’åˆ— */
      display: flex !important;
      flex-direction: row !important;
    }
    
    /* è°ƒæ•´ç¼©æ”¾æŒ‰é’®çš„æ ·å¼ */
    .leaflet-control-zoom a {
      display: inline-block !important;
      margin: 0 2px !important;
    }
    
    /* å›¾å±‚æ§åˆ¶ä½ç½®ï¼ˆæœ€ä¸Šæ–¹ï¼‰ */
    .leaflet-control-layers {
      position: fixed !important;
      bottom: 70px !important;
      left: 10px !important;
      margin: 0 !important;
      border-radius: 8px !important;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
      border: none !important;
      background-color: white !important;
    }
    
    /* ç»Ÿä¸€ç¼©ç•¥å›¾çš„å³è¾¹è· */
    .leaflet-bottom.leaflet-right .leaflet-control {
      margin-right: 10px !important;
      margin-bottom: 10px !important;
    }
    
    /* æ‚£è€…èšç±»æ ·å¼ */
    .custom-cluster {
      background: rgba(139, 0, 0, 0.5) !important; /* æ·±çº¢è‰²ï¼Œ50%é€æ˜åº¦ */
      border: 2px solid #8B0000 !important;
      border-radius: 50% !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- æ§åˆ¶é¢æ¿ -->
  <div class="control-panel">
    <h3>æ˜¾ç¤ºæ§åˆ¶</h3>
    
    <div class="control-group">
      <label>å›¾å±‚æ˜¾ç¤ºï¼š</label>
      <div class="layer-toggles-row">
        <div class="layer-toggle">
          <input type="checkbox" id="clustering-toggle" checked>
          <label for="clustering-toggle">æ‚£è€…èšç±»</label>
        </div>
        <div class="layer-toggle">
          <input type="checkbox" id="points-toggle">
          <label for="points-toggle">æ‚£è€…ç‚¹å›¾</label>
        </div>
        <div class="layer-toggle">
          <input type="checkbox" id="heatmap-toggle">
          <label for="heatmap-toggle">çƒ­åŠ›å›¾</label>
        </div>
      </div>
    </div>
    
    <div class="control-group">
      <label>èŒç§ç­›é€‰ï¼š</label>
      <select id="strain-filter">
        <option value="all">å…¨éƒ¨èŒç§</option>
        <option value="ESBLE">ESBLE</option>
        <option value="MRSA">MRSA</option>
        <option value="CRO">CRO</option>
      </select>
    </div>
  </div>
  
  <!-- ç»Ÿè®¡é¢æ¿ -->
  <div class="stats-panel">
    <h3>ç»Ÿè®¡ä¿¡æ¯</h3>
    <div class="stats-item">
      æ€»æ‚£è€…æ•°: <span class="stats-value" id="total-patients">0</span>
    </div>
    <div class="stats-item">
      å½“å‰æ˜¾ç¤º: <span class="stats-value" id="current-patients">0</span>
    </div>
    <div class="stats-item">
      ä¸»è¦èŒç§: <span class="stats-value" id="main-strain">-</span>
    </div>
    <div class="stats-item">
      çƒ­åŠ›çŠ¶æ€: <span class="stats-value" id="heat-intensity">-</span>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <script>
    // å…¨å±€å˜é‡
    let map;
    let allData = [];
    let currentData = [];
    let pointLayer;
    let heatmapLayer;
    let clusterLayer;
    let currentStrain = 'all';
    let layerControl;
    
    // èŒç§é¢œè‰²æ˜ å°„ - æ ¹æ®å®é™…æ•°æ®è°ƒæ•´
    const strainColors = {
      'ESBLE': '#e74c3c',  // çº¢è‰² - æœ€å¤š
      'MRSA': '#3498db',   // è“è‰²
      'CRO': '#f39c12'     // æ©™è‰²
    };
    
    // å›¾å±‚ç®¡ç†å˜é‡
    let currentOverlays = {};
    
    // å­˜å‚¨åŸå§‹åº•å›¾å›¾å±‚å¼•ç”¨
    let originalBaseLayers = {};
    
    // å®Œå…¨é‡å»ºå›¾å±‚æ§åˆ¶
    function rebuildLayerControl() {
      if (layerControl) {
        // ç§»é™¤ç°æœ‰çš„å›¾å±‚æ§åˆ¶
        map.removeControl(layerControl);
        
        // æ„å»ºå½“å‰çš„overlay - ä¸åŒ…å«ä»»ä½•overlayï¼Œåªä¿ç•™åº•å›¾åˆ‡æ¢
        const overlays = {};
        // æ³¨æ„ï¼šæ‚£è€…ç‚¹å›¾å’Œçƒ­åŠ›å›¾éƒ½ä¸æ·»åŠ åˆ°å›¾å±‚æ§åˆ¶ä¸­ï¼Œåªèƒ½é€šè¿‡æ˜¾ç¤ºæ§åˆ¶ç®¡ç†
        
        // é‡æ–°åˆ›å»ºå›¾å±‚æ§åˆ¶ï¼Œä½¿ç”¨åŸå§‹çš„åº•å›¾å›¾å±‚
        layerControl = L.control.layers(originalBaseLayers, overlays, {
          position: 'bottomleft',
          collapsed: true
        }).addTo(map);
      }
    }
    
    // å®‰å…¨çš„å›¾å±‚ç®¡ç†å‡½æ•°
    function safeAddOverlay(layer, name) {
      if (layer) {
        currentOverlays[name] = layer;
        // æ‚£è€…ç‚¹å›¾å’Œçƒ­åŠ›å›¾éƒ½ä¸æ·»åŠ åˆ°å›¾å±‚æ§åˆ¶ä¸­ï¼Œåªèƒ½é€šè¿‡æ˜¾ç¤ºæ§åˆ¶ç®¡ç†
        // å› æ­¤ä¸éœ€è¦é‡å»ºå›¾å±‚æ§åˆ¶
      }
    }
    
    // ç§»é™¤å›¾å±‚å‡½æ•°
    function safeRemoveOverlay(name) {
      if (currentOverlays[name]) {
        delete currentOverlays[name];
        // æ‚£è€…ç‚¹å›¾å’Œçƒ­åŠ›å›¾éƒ½ä¸æ·»åŠ åˆ°å›¾å±‚æ§åˆ¶ä¸­ï¼Œåªèƒ½é€šè¿‡æ˜¾ç¤ºæ§åˆ¶ç®¡ç†
        // å› æ­¤ä¸éœ€è¦é‡å»ºå›¾å±‚æ§åˆ¶
      }
    }
    
    // åˆ›å»ºèšç±»é…ç½®
    function createClusterConfig() {
      return {
        maxClusterRadius: 50,        // æœ€å¤§èšç±»åŠå¾„
        spiderfyOnMaxZoom: true,     // æœ€å¤§ç¼©æ”¾æ—¶å±•å¼€
        showCoverageOnHover: false,  // æ‚¬åœæ—¶æ˜¾ç¤ºè¦†ç›–èŒƒå›´
        zoomToBoundsOnClick: true,   // ç‚¹å‡»æ—¶ç¼©æ”¾åˆ°åŒºåŸŸ
        disableClusteringAtZoom: 15, // 15çº§ç¼©æ”¾æ—¶ç¦ç”¨èšç±»
        // è‡ªå®šä¹‰èšç±»å›¾æ ‡
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          
          // çº¿æ€§å¢é•¿è®¡ç®—ç›´å¾„ï¼š20px (1-10ä¸ªæ‚£è€…) åˆ° 60px (>50ä¸ªæ‚£è€…)
          const minDiameter = 20;
          const maxDiameter = 60;
          const minCount = 1;
          const maxCount = 50;
          
          // çº¿æ€§æ’å€¼è®¡ç®—ç›´å¾„
          const diameter = Math.min(
            minDiameter + (count - minCount) / (maxCount - minCount) * (maxDiameter - minDiameter),
            maxDiameter
          );
          
          return L.divIcon({
            html: `<div class="cluster-marker" style="width: ${diameter}px; height: ${diameter}px; line-height: ${diameter}px;"></div>`,
            className: 'custom-cluster',
            iconSize: L.point(diameter, diameter)
          });
        }
      };
    }

    // åˆå§‹åŒ–åœ°å›¾
    function initMap() {
      map = L.map('map', {
        zoomControl: false  // ç¦ç”¨é»˜è®¤çš„ç¼©æ”¾æ§ä»¶
      }).setView([22.2514, 113.5674], 11); // ç æµ·å¸‚ä¸­å¿ƒ
      
      // åˆ›å»ºå¤šä¸ªåº•å›¾å›¾å±‚
      const lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd'
      });
      
      const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
        subdomains: 'abcd'
      });
      
      const streetMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      });
      
      // æ·»åŠ é»˜è®¤åº•å›¾
      lightMap.addTo(map);
      
      // ä¿å­˜åŸå§‹åº•å›¾å›¾å±‚å¼•ç”¨
      originalBaseLayers = {
        "ç®€æ´åœ°å›¾": lightMap,
        "æ·±è‰²åœ°å›¾": darkMap,
        "è¡—é“åœ°å›¾": streetMap
      };
      
      // æ·»åŠ å›¾å±‚æ§åˆ¶
      layerControl = L.control.layers(originalBaseLayers, {}, {
        position: 'bottomleft',
        collapsed: true
      }).addTo(map);
      
      // æ·»åŠ è‡ªå®šä¹‰ç¼©æ”¾æ§ä»¶åˆ°å·¦ä¸‹è§’
      L.control.zoom({
        position: 'bottomleft'
      }).addTo(map);
      
      // æ·»åŠ å›¾ä¾‹
      addLegend();
    }
    
    // æ£€æµ‹è¿è¡Œç¯å¢ƒ
    function detectEnvironment() {
      if (window.location.protocol === 'file:') {
        return 'local'; // æœ¬åœ°æ–‡ä»¶è®¿é—®
      } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'development'; // æœ¬åœ°æœåŠ¡å™¨
      } else {
        return 'production'; // åœ¨çº¿ç‰ˆæœ¬
      }
    }
    
    // æ˜¾ç¤ºæœ¬åœ°æ–‡ä»¶è®¿é—®æç¤º
    function showLocalFileMessage() {
      // åˆ›å»ºæç¤ºä¿¡æ¯
      const messageDiv = document.createElement('div');
      messageDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 500px;
        text-align: center;
        font-family: 'Microsoft YaHei', Arial, sans-serif;
      `;
      
      messageDiv.innerHTML = `
        <h3 style="color: #e74c3c; margin-bottom: 20px;">ğŸ“ æœ¬åœ°æ–‡ä»¶è®¿é—®æ¨¡å¼</h3>
        <p style="margin-bottom: 15px; line-height: 1.6;">
          æ£€æµ‹åˆ°æ‚¨æ­£åœ¨é€šè¿‡æœ¬åœ°æ–‡ä»¶æ–¹å¼è®¿é—®åœ°å›¾åº”ç”¨ã€‚
        </p>
        <p style="margin-bottom: 20px; line-height: 1.6; color: #666;">
          ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥åŠ è½½æ•°æ®æ–‡ä»¶ã€‚è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š
        </p>
        <div style="text-align: left; margin-bottom: 20px;">
          <p><strong>æ–¹æ³•1ï¼š</strong>åŒå‡» <code>å¯åŠ¨åœ°å›¾.bat</code> æ–‡ä»¶</p>
          <p><strong>æ–¹æ³•2ï¼š</strong>åœ¨å‘½ä»¤è¡Œè¿è¡Œï¼š<code>python -m http.server 8000</code></p>
          <p><strong>æ–¹æ³•3ï¼š</strong>ä½¿ç”¨å…¶ä»–HTTPæœåŠ¡å™¨å·¥å…·</p>
        </div>
        <button onclick="this.parentElement.remove()" style="
          background: #007cba;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          font-size: 14px;
        ">æˆ‘çŸ¥é“äº†</button>
      `;
      
      document.body.appendChild(messageDiv);
    }
    
    // åŠ è½½æ•°æ®
    async function loadData() {
      const env = detectEnvironment();
      
      if (env === 'local') {
        // æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
        showLocalFileMessage();
        return;
      }
      
      try {
        const response = await fetch('data/mdro_patients.json');
        allData = await response.json();
        currentData = allData.features;
        
        updateMap();
        updateStats();
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        
        // å¦‚æœæ˜¯åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸‹åŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºæç¤º
        if (env !== 'local') {
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #f5c6cb;
            z-index: 10000;
            max-width: 300px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
          `;
          errorDiv.innerHTML = `
            <strong>æ•°æ®åŠ è½½å¤±è´¥</strong><br>
            è¯·ç¡®ä¿ <code>data/mdro_patients.json</code> æ–‡ä»¶å­˜åœ¨
          `;
          document.body.appendChild(errorDiv);
          
          // 5ç§’åè‡ªåŠ¨ç§»é™¤é”™è¯¯æç¤º
          setTimeout(() => {
            if (errorDiv.parentElement) {
              errorDiv.remove();
            }
          }, 5000);
        }
      }
    }
    
    // ç”Ÿæˆçƒ­åŠ›å›¾æ•°æ®
    function generateHeatmapData(filteredData) {
      const heatmapPoints = [];
      
      // è®¡ç®—æ¯ä¸ªç‚¹çš„å¯†åº¦æƒé‡
      filteredData.forEach(feature => {
        const coords = feature.geometry.coordinates;
        const lat = coords[1];
        const lng = coords[0];
        
        // è®¡ç®—è¯¥ç‚¹å‘¨å›´çš„æ‚£è€…å¯†åº¦
        let density = 0;
        filteredData.forEach(otherFeature => {
          const otherCoords = otherFeature.geometry.coordinates;
          const otherLat = otherCoords[1];
          const otherLng = otherCoords[0];
          
          // è®¡ç®—è·ç¦»ï¼ˆç®€åŒ–è®¡ç®—ï¼‰
          const distance = Math.sqrt(
            Math.pow(lat - otherLat, 2) + Math.pow(lng - otherLng, 2)
          ) * 111; // å¤§è‡´è½¬æ¢ä¸ºå…¬é‡Œ
          
          // è·ç¦»è¶Šè¿‘æƒé‡è¶Šå¤§ï¼Œä½¿ç”¨é«˜æ–¯æ ¸å‡½æ•°
          if (distance <= 5) { // 5å…¬é‡ŒèŒƒå›´å†…
            const weight = Math.exp(-Math.pow(distance, 2) / (2 * Math.pow(1.5, 2)));
            density += weight;
          }
        });
        
        // å½’ä¸€åŒ–å¯†åº¦å€¼åˆ°0-1èŒƒå›´
        const normalizedDensity = Math.min(density / 10, 1.0);
        heatmapPoints.push([lat, lng, normalizedDensity]);
      });
      
      return heatmapPoints;
    }
    
    // æ›´æ–°åœ°å›¾æ˜¾ç¤º
    function updateMap() {
      // æ¸…é™¤ç°æœ‰å›¾å±‚
      if (pointLayer) {
        map.removeLayer(pointLayer);
        safeRemoveOverlay("æ‚£è€…ç‚¹å›¾");
      }
      if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
        safeRemoveOverlay("çƒ­åŠ›å›¾");
      }
      if (clusterLayer) map.removeLayer(clusterLayer);
      
      // è¿‡æ»¤æ•°æ®
      const filteredData = currentData.filter(feature => {
        const props = feature.properties;
        const strainMatch = currentStrain === 'all' || props.strain === currentStrain;
        return strainMatch;
      });
      
      // æ·»åŠ èšç±»å›¾å±‚
      if (document.getElementById('clustering-toggle').checked) {
        clusterLayer = L.markerClusterGroup(createClusterConfig());
        
        // æ·»åŠ æ‚£è€…ç‚¹åˆ°èšç±»
        filteredData.forEach(feature => {
          const coords = feature.geometry.coordinates;
          const props = feature.properties;
          const color = strainColors[props.strain] || '#999';
          
          const marker = L.circleMarker([coords[1], coords[0]], {
            radius: 6,
            fillColor: color,
            color: '#333',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          });
          
          // ç»‘å®šå¼¹çª—
          marker.bindPopup(`
            <div style="min-width: 200px;">
              <h4>æ‚£è€…ä¿¡æ¯</h4>
              <p><strong>æ‚£è€…IDï¼š</strong>${props.id}</p>
              <p><strong>èŒç§ï¼š</strong>${props.strain}</p>
            </div>
          `);
          
          clusterLayer.addLayer(marker);
        });
        
        // æ‚£è€…èšç±»ä¸éœ€è¦æ·»åŠ åˆ°å›¾å±‚æ§åˆ¶ä¸­
        
        clusterLayer.addTo(map);
      }
      
      // æ·»åŠ ç‚¹å›¾å±‚
      if (document.getElementById('points-toggle').checked) {
        pointLayer = L.geoJSON(filteredData, {
          onEachFeature: function (feature, layer) {
            const props = feature.properties;
            layer.bindPopup(`
              <div style="min-width: 200px;">
                <h4>æ‚£è€…ä¿¡æ¯</h4>
                <p><strong>æ‚£è€…IDï¼š</strong>${props.id}</p>
                <p><strong>èŒç§ï¼š</strong>${props.strain}</p>
              </div>
            `);
          },
          pointToLayer: function (feature, latlng) {
            const props = feature.properties;
            const color = strainColors[props.strain] || '#999';
            
            return L.circleMarker(latlng, {
              radius: 8,
              fillColor: color,
              color: '#333',
              weight: 2,
              opacity: 1,
              fillOpacity: 0.8
            });
          }
        });
        
        // æ›´æ–°å›¾å±‚æ§åˆ¶
        safeAddOverlay(pointLayer, "æ‚£è€…ç‚¹å›¾");
        
        pointLayer.addTo(map);
      }
      
      // æ·»åŠ çƒ­åŠ›å›¾
      if (document.getElementById('heatmap-toggle').checked && filteredData.length > 0) {
        const heatmapData = generateHeatmapData(filteredData);
        
        if (heatmapData.length > 0) {
          // æ ¹æ®æ•°æ®é‡è°ƒæ•´çƒ­åŠ›å›¾å‚æ•°
          const radius = filteredData.length > 100 ? 25 : 20;
          const blur = filteredData.length > 100 ? 20 : 15;
          
          heatmapLayer = L.heatLayer(heatmapData, {
            radius: radius,
            blur: blur,
            maxZoom: 10,
            gradient: {
              0.2: '#ffffcc',
              0.4: '#ffeda0',
              0.6: '#fed976',
              0.8: '#feb24c',
              1.0: '#f03b20'
            }
          });
          
          // æ›´æ–°å›¾å±‚æ§åˆ¶
          safeAddOverlay(heatmapLayer, "çƒ­åŠ›å›¾");
          
          heatmapLayer.addTo(map);
          
          // æ›´æ–°çƒ­åŠ›å¼ºåº¦ç»Ÿè®¡
          const maxIntensity = Math.max(...heatmapData.map(point => point[2]));
          document.getElementById('heat-intensity').textContent = `çƒ­åŠ›å³°å€¼: ${maxIntensity.toFixed(3)}`;
          
          // æ›´æ–°colorbaræ ‡ç­¾
          updateColorbarLabels(heatmapData);
        }
      }
      
      updateStats();
    }
    
    // æ·»åŠ å›¾ä¾‹
    function addLegend() {
      const legend = L.control({ position: 'bottomright' });
      
      legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <h4>å›¾ä¾‹</h4>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #e74c3c;"></div>
            <span>ESBLE</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #3498db;"></div>
            <span>MRSA</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: #f39c12;"></div>
            <span>CRO</span>
          </div>
          <hr style="margin: 10px 0;">
          <div class="legend-item">
            <div class="legend-color" style="background-color: rgba(139, 0, 0, 0.5); border-radius: 50%; width: 30px; height: 30px;"></div>
            <span>æ‚£è€…èšç±»</span>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            åœ†åœˆå¤§å°è¡¨ç¤ºæ‚£è€…æ•°é‡
          </div>
          <hr style="margin: 10px 0;">
          <div class="legend-item">
            <span>çƒ­åŠ›å›¾å¼ºåº¦</span>
          </div>
          <div class="colorbar-container">
            <div class="colorbar" id="heatmap-colorbar"></div>
            <div class="colorbar-labels" id="colorbar-labels">
              <span>0</span>
              <span>0.5</span>
              <span>1.0</span>
            </div>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 10px;">
            çƒ­åŠ›å›¾åŸºäºæ‚£è€…èšé›†ç¨‹åº¦è®¡ç®—
          </div>
        `;
        return div;
      };
      
      legend.addTo(map);
    }
    
    // æ›´æ–°colorbaræ ‡ç­¾
    function updateColorbarLabels(heatmapData) {
      const colorbarLabels = document.getElementById('colorbar-labels');
      if (colorbarLabels && heatmapData.length > 0) {
        const maxIntensity = Math.max(...heatmapData.map(point => point[2]));
        const minIntensity = Math.min(...heatmapData.map(point => point[2]));
        const midIntensity = (minIntensity + maxIntensity) / 2;
        
        colorbarLabels.innerHTML = `
          <span>${minIntensity.toFixed(3)}</span>
          <span>${midIntensity.toFixed(3)}</span>
          <span>${maxIntensity.toFixed(3)}</span>
        `;
      }
    }
    
    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
      const totalPatients = allData.features.length;
      
      // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è®¡ç®—æ˜¾ç¤ºçš„æ‚£è€…æ•°
      const filteredData = currentData.filter(feature => {
        const props = feature.properties;
        const strainMatch = currentStrain === 'all' || props.strain === currentStrain;
        return strainMatch;
      });
      
      const currentPatients = filteredData.length;
      
      // è®¡ç®—ä¸»è¦èŒç§ - åŸºäºå½“å‰ç­›é€‰çš„æ•°æ®
      const strainCounts = {};
      filteredData.forEach(feature => {
        const strain = feature.properties.strain;
        strainCounts[strain] = (strainCounts[strain] || 0) + 1;
      });
      
      let mainStrain = '-';
      if (currentStrain === 'all') {
        // æ˜¾ç¤ºæ‰€æœ‰èŒç§æ—¶ï¼Œæ˜¾ç¤ºæ•°é‡æœ€å¤šçš„èŒç§
        if (Object.keys(strainCounts).length > 0) {
          mainStrain = Object.entries(strainCounts).sort((a, b) => b[1] - a[1])[0][0];
        }
      } else {
        // ç­›é€‰ç‰¹å®šèŒç§æ—¶ï¼Œæ˜¾ç¤ºè¯¥èŒç§
        mainStrain = currentStrain;
      }
      
      document.getElementById('total-patients').textContent = totalPatients;
      document.getElementById('current-patients').textContent = currentPatients;
      document.getElementById('main-strain').textContent = mainStrain;
    }
    
    // äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
      // å›¾å±‚åˆ‡æ¢
      document.getElementById('clustering-toggle').addEventListener('change', updateMap);
      document.getElementById('points-toggle').addEventListener('change', updateMap);
      document.getElementById('heatmap-toggle').addEventListener('change', updateMap);
      
      // èŒç§ç­›é€‰
      document.getElementById('strain-filter').addEventListener('change', function() {
        currentStrain = this.value;
        updateMap();
      });
    }
    
    // åˆå§‹åŒ–åº”ç”¨
    function init() {
      initMap();
      loadData();
      setupEventListeners();
    }
    
    // å¯åŠ¨åº”ç”¨
    init();
  </script>
</body>
</html>
